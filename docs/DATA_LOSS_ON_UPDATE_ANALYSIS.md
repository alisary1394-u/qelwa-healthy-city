# تحليل: حذف البيانات عند التحديث (النشر)

## الخلاصة

**السبب الرئيسي لحذف البيانات عند كل تحديث (نشر) هو عدم وجود تخزين دائم (Volume) لملف قاعدة البيانات وملفات النسخ الاحتياطية.** عند كل نشر جديد، المنصة (مثل Railway) تشغّل حاوية جديدة بقرص مؤقت؛ فإذا لم يكن المسار `/data` مربوطاً بـ Volume، تُفقد كل البيانات.

---

## 1. أين تُحفظ البيانات في التطبيق؟

| المكوّن        | المسار (على Railway)   | المحلي (التطوير)           |
|----------------|------------------------|----------------------------|
| قاعدة SQLite   | `/data/qelwa.db`       | `server/data/qelwa.db`     |
| النسخ الاحتياطية | `/data/backups/*.json` | `server/data/backups/*.json` |

- مصدر المسار: `server/db.js` (DEFAULT_DB_PATH) و `server/backup.js` (backupDirDefault).
- إذا لم يُضبط `DB_PATH` أو `BACKUP_DIR`، يُستخدم المسار الافتراضي أعلاه.

---

## 2. لماذا تُحذف البيانات عند التحديث؟

### السبب الرئيسي: عدم ربط Volume على `/data` (مثلاً على Railway)

- عند كل **نشر (Deploy)**، المنصة تبني صورة جديدة وتشغّل **حاوية جديدة**.
- قرص الحاوية **مؤقت (Ephemeral)**: كل ما يُكتب على `/data` داخل الحاوية يختفي عند إيقافها أو استبدالها.
- إذا **لم** تربط Volume على `/data`:
  - ملف `qelwa.db` يُنشأ من الصفر في كل نشر → قاعدة بيانات **فارغة**.
  - مجلد النسخ الاحتياطية فارغ → لا استعادة من نسخة سابقة.
- النتيجة: بعد كل "تحديث" (نشر) يبدو للمستخدم أن **كل البيانات انحذفت** (بما فيها المحافظ والأعضاء).

### أسباب أخرى (أقل احتمالاً في سيناريو "عند التحديث")

| السبب | الوصف | هل يفسر "حذف عند التحديث"؟ |
|--------|--------|-----------------------------|
| استدعاء `POST /api/seed?clear=1` | يمسح جداول (لجان، مهام، ميزانيات…) ولا يمسح `team_member`. | لا يمسح المحافظ؛ يفسر فقدان جزء من البيانات فقط إن ضُغط الزر صراحة. |
| استعادة نسخة احتياطية قديمة | `restoreBackup` يستبدل كل الجداول بنسخة من ملف. | يفسر فقدان بيانات فقط إذا وُجدت نسخ واحتُجنا لاستعادتها؛ لا يحدث تلقائياً عند "تحديث" بدون Volume. |
| حارس النسخ (autoRestoreOnLowTeam) | عند انخفاض عدد الفريق يمكن استعادة من نسخة أو إعادة بذر. | معطّل افتراضياً؛ وإذا لم يكن هناك Volume فلا توجد نسخ للاستعادة أصلاً. |

خلاصة: في بيئة نشر (مثل Railway) بدون Volume، **التحديث = حاوية جديدة + قرص مؤقت = فقدان كل البيانات**، وهذا هو التفسير الأقوى لـ "حذف البيانات عند التحديث".

---

## 3. مسارات الكود التي تمسح أو تستبدل البيانات

### 3.1 مسح الجداول (clearTable)

- **الموقع:** `server/db.js` → `clearTable(table)` تنفّذ `DELETE FROM table`.
- **من يستدعيها:**
  1. **`POST /api/seed?clear=1`** (`server/index.js`):  
     يمسح فقط الجداول المدرجة في `TABLES_CLEAR_ON_RESEED` (لجان، محاور، معايير، مبادرات، مهام، ميزانيات، معاملات).  
     **لا يمسح أبداً:** `team_member` (محمي في `NEVER_CLEAR_TABLES`).
  2. **`restoreBackup(filePath)`** (`server/backup.js`):  
     يمسح **كل** الجداول ثم يملأها من ملف النسخة الاحتياطية. الاستدعاء يكون يدوياً (واجهة الاستعادة أو أوامر backup-cli) أو عبر حارس النسخ إذا فُعّل.

- **لا يوجد استدعاء تلقائي لـ clearTable أو لـ seed?clear=1 عند بدء السيرفر أو عند "تحديث" الكود.** أي مسح يحدث فقط بفعل:
  - طلب صريح من المستخدم (زر في الإعدادات أو استدعاء API)، أو
  - استعادة نسخة احتياطية (يدوياً أو بحارس معطّل افتراضياً).

### 3.2 البذر التلقائي عند عدم وجود أعضاء

- **الموقع:** `server/index.js` → `ensureMinimalSeedOnStartup()` و `GET /api/bootstrap`.
- **السلوك:** يُنفَّذ فقط عندما `team_member.length === 0`؛ يضيف بيانات (مشرف، فريق تجربة، إلخ) ولا يمسح أي جدول.
- **النتيجة:** لا يسبب فقدان بيانات؛ يملأ قاعدة فارغة فقط.

---

## 4. التوصيات لمنع حذف البيانات عند التحديث

### 4.1 (إلزامي) ربط Volume على `/data` عند النشر على Railway

- في Railway: إضافة **Volume** وربطه بمسار **`/data`** للخدمة.
- التأكد أن **نفس** Volume مُربوط في كل النشرات (لا إعادة إنشاء Volume يبدأ من صفر).
- بعد الربط:
  - `qelwa.db` يبقى بين النشرات.
  - النسخ الاحتياطية في `/data/backups` تبقى وتُستخدم للاستعادة عند الحاجة.

بدون هذا، **كل تحديث (نشر) سيستمر في "حذف" كل البيانات** لأن الحاوية الجديدة تبدأ بقرص فارغ.

### 4.2 توثيق واضح في دليل النشر

- في `DEPLOY.md` (وفي أي دليل نشر آخر): ذكر صراحة أن **استمرارية البيانات تعتمد على ربط Volume على `/data`**، مع خطوات Railway إن أمكن.
- الإشارة إلى أن عدم ربط Volume هو السبب المعتاد لـ "حذف البيانات عند التحديث".

### 4.3 تحذير عند بدء السيرفر

- عند التشغيل على Railway (أو بيئة إنتاج مشابهة): إذا وُجد أن قاعدة البيانات فارغة (مثلاً لا يوجد أعضاء)، طباعة تحذير في السجلات يذكر أن **البيانات قد تُفقد عند كل نشر إن لم يكن المسار `/data` مربوطاً بـ Volume**، مع توجيه المستخدم إلى التوثيق.

---

## 5. ملخص مسارات "حذف" أو استبدال البيانات

| المسار | يمسح/يستبدل؟ | متى يُستدعى |
|--------|----------------|-------------|
| نشر جديد بدون Volume | فعلياً "حذف" كل البيانات | كل مرة يُنشر فيها التطبيق |
| `POST /api/seed?clear=1` | يمسح جداول البذرة فقط (ولا يمسح team_member) | عند ضغط "مسح البيانات وإعادة تحميل بيانات التجربة" من الإعدادات |
| `restoreBackup(...)` | يستبدل كل الجداول بنسخة احتياطية | استعادة يدوية أو حارس (معطّل افتراضياً) |
| `ensureMinimalSeedOnStartup` / `GET /api/bootstrap` | لا يمسح؛ يضيف فقط عند عدم وجود أعضاء | عند بدء السيرفر أو طلب تهيئة عند فريق فارغ |

**الخلاصة العملية:** لوقف "حذف البيانات عند التحديث" يجب ضمان أن **قاعدة البيانات والنسخ الاحتياطية تعيش على تخزين دائم (Volume على `/data`)** وعدم الاعتماد على قرص الحاوية المؤقت.

---

## 6. رسائل السجلات (Logs) الشائعة

### `npm error signal SIGTERM` / `command sh -c node server/index.js` failed

- **المعنى:** المنصة أرسلت إشارة إيقاف (SIGTERM) إلى العملية — غالباً عند **إعادة النشر** (إيقاف الحاوية القديمة وتشغيل حاوية جديدة).
- **هل هو خطأ؟** في سياق النشر المتتابع يعتبر طبيعياً. التطبيق يغلق الاستماع ثم يخرج برمز 0 لتقليل ظهور "command failed".
- **إذا تكرر كل دقائق:** تحقق من فحص الصحة (Health Check) وأن المسار مضبوط (مثلاً `/api/health`) وأن السيرفر يرد خلال المهلة المحددة.

### `[Qelwa] تنبيه: لا يوجد أعضاء. إذا كان هذا يحدث بعد كل نشر...`

- **المعنى:** عند بدء السيرفر لم يُوجد أي عضو في الفريق (قاعدة فارغة أو قرص مؤقت).
- **السبب المعتاد:** عدم ربط **Volume** على `/data`، فكل نشر يبدأ بقرص جديد فارغ.
- **الحل:** ربط Volume على المسار `/data` في إعدادات الخدمة (مثلاً Railway → Volumes) حتى تبقى قاعدة البيانات والنسخ الاحتياطية بين النشرات.
