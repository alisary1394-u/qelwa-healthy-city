/**
 * المعايير المحسنة مع المؤشرات المتقدمة
 * إعادة بناء شاملة للمعايير مع مؤشرات أداء احترافية
 */

import { 
  buildAdvancedKpisForStandard, 
  buildRequiredDocumentsForStandard,
  buildVerificationMethodsForStandard 
} from './enhancedKpis.js';

import { AXES_CSV, AXIS_COUNTS_CSV } from './standardsFromCsv.js';

/**
 * بناء المعايير المحسنة مع المؤشرات المتقدمة
 */
export function buildEnhancedStandards() {
  const enhancedStandards = [];
  let standardIndex = 0;

  // معايير المحور 1: تنظيم المجتمع وتعبئته
  const axis1Standards = [
    'اختيرت ودربت المجموعات المكونة من الممثلين والمتطوعين على تقييم الاحتياجات، وترتيب الأولويات، وتحليل المعطيات، وإعداد المشروع، والرصد وآليات التسجيل وآليات الإبلاغ.',
    'تنظم لجنة تنسيق أعمال المدينة الصحية اجتماعات منتظمة (شهرية على الأقل) لمناقشة القضايا الصحية المحلية وتخطيط وتنفيذ الأنشطة.',
    'يتم توفير منسق للمدينة الصحية للعمل مع لجنة تنسيق أعمال المدينة الصحية والجهات الفاعلة الأخرى.',
    'يتم إنشاء مركز اجتماعي مجتمعي لتنفيذ أنشطة المدينة الصحية.',
    'تم تدريب الممثلين والمتطوعين من المجموعات المختلفة على القضايا الصحية والبرامج ذات العلاقة بالصحة.',
    'تشارك المجموعات المكونة بنشاط في تحديد الأولويات الصحية للمجتمع وتخطيط وتنفيذ الحلول.',
    'يتم إشراك المجتمع في مراقبة وتقييم أنشطة المدينة الصحية.'
  ];

  // معايير المحور 2: التعاون والشراكة
  const axis2Standards = [
    'تم تشكيل لجنة تنسيق أعمال المدينة الصحية مع ممثلين من مختلف القطاعات الحكومية وغير الحكومية.',
    'توجد شراكات رسمية مع منظمات المجتمع المدني والقطاع الخاص لدعم أنشطة المدينة الصحية.',
    'يتم تنسيق الأنشطة مع السلطات الصحية المحلية والإقليمية.',
    'توجد آليات واضحة للتنسيق بين مختلف الشركاء.',
    'يتم مشاركة الموارد والخبرات بين الشركاء.',
    'يتم تقييم فعالية الشراكات والتنسيق بانتظام.',
    'يتم الدعوة والدعم للسياسات الصحية على المستوى المحلي.'
  ];

  // معايير المحور 3: مركز المعلومات
  const axis3Standards = [
    'تم إنشاء مركز معلومات مجتمعي يوفر الوصول إلى معلومات الصحة.',
    'يتم جمع وتحليل ونشر البيانات الصحية المحلية بانتظام.',
    'يتم توفير معلومات للمجتمع حول القضايا الصحية والخدمات المتاحة.',
    'يتم استخدام التكنولوجيا لنشر المعلومات الصحية.',
    'يتم تقييم استخدام وفعالية معلومات المركز بانتظام.'
  ];

  // معايير المحور 4: المياه والصرف الصحي والغذاء والهواء
  const axis4Standards = [
    'موقع تنفيذ البرنامج نظيف وبه مساحات خضراء كافية.',
    'الانتهاء من إنشاء نظام مجتمعي فعّال لمعالجة النفايات الصلبة.',
    'تم عمل مخطط مصادر المياه وحمايتها بصورة واضحة عن طريق الخرائط.',
    'وصول جميع العائلات إلى مياه شرب آمنة ومرافق صرف صحي أساسية.',
    'تدريب الممثلين والمتطوعين على الحفاظ على البيئات والمواقع الصحية.',
    'مشاركة المجتمع في سلامة الغذاء ومراقبة جميع الأسواق المحلية.',
    'تحسين إمكانية الوصول إلى الأسواق التي تبيع الأغذية الصحية.',
    'حظر التدخين في الأماكن المغلقة والأماكن العامة.',
    'إنشاء مركز مجتمعي لجودة الهواء لضمان المراقبة المنتظمة.',
    'قيام مخططي المدينة بتنفيذ التدخلات التي تحد من تلوث الهواء.',
    'إجراء تقييم التأثير البيئي قبل الموافقة على المشاريع.'
  ];

  // معايير المحور 5: التنمية الصحية
  const axis5Standards = [
    'تم تدريب ممثلي المجموعات والمتطوعين الصحيين على القضايا الصحية.',
    'يقوم ممثلو المجتمع بتسجيل وتبليغ حالات الولادة والوفيات.',
    'انتهاء لجنة تنسيق أعمال المدينة الصحية بإنشاء نظم إحالة مستدامة.',
    'الانتهاء من تدريب المجتمع على مشاريع البحوث المجتمعية.',
    'تشكيل لجنة فرعية لإدارة خدمات الرعاية الصحية المحلية.',
    'توفر الأدوية الأساسية واللقاحات في المرافق الصحية.',
    'إجراء تقييمات جودة لخدمات الرعاية الصحية ورضا المستخدمين.',
    'حصول جميع الحوامل على رعاية ما قبل الولادة في الوقت المناسب.',
    'حصول جميع الأمهات على رعاية ما بعد الولادة لمدة 40 يوماً.',
    'تطعيم جميع الأطفال ضد الأمراض قبل بلوغهم السنة الأولى.',
    'تسجيل جميع المواليد وتطعيمهم حسب الجدول الوطني.',
    'مشاركة فعالة في حملات استئصال شلل الأطفال.',
    'إتاحة خدمات الرعاية الصحية للأطفال دون الخامسة.',
    'تحديد الأطفال والأمهات المصابين بسوء التغذية ونقص الفيتامينات.',
    'تنفيذ استراتيجية DOTS لعلاج السل تحت الإشراف المباشر.',
    'تنفيذ برنامج لمكافحة الملاريا بمشاركة فعالة من المجتمع.',
    'الإبلاغ عن الحالات المشتبه فيها والأمراض المعدية.',
    'تثقيف المجتمع حول طرق عدوى الإيدز والوقاية.',
    'تحديد جميع مرضى الأمراض المزمنة ووضع خطة متابعة.',
    'تحديد الحالات المصابة باضطرابات نفسية وتقديم الدعم.',
    'تحديد ذوي العجز البدني وتأمين قدراتهم على كسب الرزق.',
    'تحديد الأماكن الخطرة واتخاذ التدابير المناسبة.',
    'تحقق خلو المنطقة من الجريمة والعنف والتمييز.',
    'دعم المجتمع لبرامج الطفولة المبكرة.',
    'تنفيذ مبادرات الصحة المدرسية في جميع المدارس.',
    'توفر إجراءات الصحة والسلامة المهنية في أماكن العمل.'
  ];

  // معايير المحور 6: الطوارئ
  const axis6Standards = [
    'تم تحديد حالات الطوارئ التي حدثت خلال العشرين عاماً السابقة.',
    'إنشاء لجنة فرعية للاستعداد للطوارئ والاستجابة لها.',
    'انتهاء إعداد مخطط للمدينة وحفظ صورة منه خارج المنطقة.',
    'تم تدريب ممثلي المجتمع على خطط الاستعداد للطوارئ.',
    'تم إعداد خطة احتياطية للطوارئ وإعلام السلطات المختصة.',
    'تحديد المجموعات السكانية المستضعفة باستخدام الخرائط.'
  ];

  // معايير المحور 7: التعليم
  const axis7Standards = [
    'التحاق جميع الأطفال في سن الدراسة بالمدارس وعدم التسرب.',
    'يعقد مديرو المدارس اجتماعات دورية مع اللجان المحلية.',
    'توجد معايير جودة التعليم في أماكنها بالمدارس.',
    'تم تشكيل لجنة فرعية للتعليم ورصد ومراقبة المدارس.',
    'تم تشجيع الشباب والنساء على العمل في حملات محو الأمية.'
  ];

  // معايير المحور 8: المهارات والتدريب
  const axis8Standards = [
    'انتهت إجراءات تقييم وتعزيز المهارات المحلية والتقنيات المناسبة.',
    'أنشئت مراكز التدريب على المهارات التي ترتبط بالأسواق المحلية.',
    'تعطي لجنة تنسيق أعمال المدينة الصحية الأولوية لقروض الطلبة.',
    'أصبحت مراكز التدريب المهني ذاتية التمويل والإدارة.',
    'أنشئت مراكز التدريب على الحاسوب واللغات والرياضة.',
    'يتم تحديد المبدعين والمبتكرين ودعمهم وتعزيزهم.'
  ];

  // معايير المحور 9: القروض الصغيرة
  const axis9Standards = [
    'يتم تحديد الفقراء والمحتاجين وفقاً لمعايير محددة متفق عليها.',
    'التربيط بين المهارات المحلية ومراكز التدريب وأنشطة الإقراض.',
    'تسجيل جميع القضايا المالية ومتابعتها من قبل المسؤول المالي.',
    'تسديد القروض على أساس نظامي وآلية متابعة واضحة.',
    'تم فتح حساب مصرفي للجنة وتتم التعاملات المالية عبر البنك.',
    'يتم أخذ نسبة 5-10% لخدمات القروض في صندوق التنمية.',
    'ممثلو المجموعات يضمنون سداد الودائع في الوقت المناسب.'
  ];

  const allAxisStandards = [
    axis1Standards, axis2Standards, axis3Standards, axis4Standards,
    axis5Standards, axis6Standards, axis7Standards, axis8Standards, axis9Standards
  ];

  // بناء المعايير المحسنة
  allAxisStandards.forEach((axisStandards, axisIndex) => {
    const axisOrder = axisIndex + 1;
    const axis = AXES_CSV[axisIndex];
    
    axisStandards.forEach((title, standardIndex) => {
      const globalNum = standardIndex + 1;
      const code = `م${axisOrder}-${standardIndex + 1}`;
      
      const enhancedStandard = {
        code,
        title,
        description: title,
        axis_name: axis.name,
        axis_order: axisOrder,
        global_num: standardIndex + 1,
        
        // المؤشرات المتقدمة
        kpis: buildAdvancedKpisForStandard(title, globalNum, axisOrder),
        
        // المستندات المطلوبة
        required_documents: buildRequiredDocumentsForStandard(title, axisOrder),
        
        // طرق التحقق
        verification_methods: buildVerificationMethodsForStandard(title, axisOrder),
        
        // معلومات إضافية
        category: 'معيار صحة مجتمعية',
        priority: axisOrder <= 3 ? 'عالية' : axisOrder <= 6 ? 'متوسطة' : 'منخفضة',
        estimated_implementation_time: axisOrder === 5 ? '6-12 شهر' : '3-6 شهر',
        required_resources: getRequiredResources(axisOrder, title),
        success_indicators: getSuccessIndicators(axisOrder, title),
        challenges: getPotentialChallenges(axisOrder, title),
        
        status: 'not_started',
        completion_percentage: 0,
        last_updated: new Date().toISOString(),
        assigned_to: null,
        due_date: null
      };
      
      enhancedStandards.push(enhancedStandard);
    });
  });

  return enhancedStandards;
}

/**
 * تحديد الموارد المطلوبة لكل معيار
 */
function getRequiredResources(axisOrder, title) {
  const resources = {
    human: ['منسق البرنامج', 'ممثلون مجتمعيون', 'متطوعون'],
    financial: ['ميزانية البرنامج', 'تمويل إضافي'],
    physical: ['مركز مجتمعي', 'معدات', 'مواد تدريب'],
    technical: ['خبراء فنيون', 'دعم فني']
  };

  if (axisOrder === 4) {
    resources.physical.push('معدات فحص المياه', 'معدات معالجة النفايات');
    resources.technical.push('خبراء بيئة');
  }
  if (axisOrder === 5) {
    resources.human.push('عاملون صحيون', 'ممرضون');
    resources.physical.push('معدات طبية', 'أدوية');
  }
  if (axisOrder === 8) {
    resources.physical.push('مراكز تدريب', 'معدات حاسوب');
    resources.technical.push('مدربون متخصصون');
  }
  if (axisOrder === 9) {
    resources.financial.push('صندوق قروض دوار');
    resources.human.push('محاسب مالي');
  }

  return resources;
}

/**
 * تحديد مؤشرات النجاح لكل معيار
 */
function getSuccessIndicators(axisOrder, title) {
  const indicators = ['تحقيق الأهداف المحددة', 'مشاركة مجتمعية فعالة'];
  
  if (axisOrder === 1) {
    indicators.push('تشكيل لجان فعالة', 'تنفيذ تدريبات ناجحة');
  }
  if (axisOrder === 4) {
    indicators.push('تحسين جودة المياه', 'نظام فعال للنفايات');
  }
  if (axisOrder === 5) {
    indicators.push('تحسين مؤشرات الصحية', 'زيادة التغطية الصحية');
  }
  if (axisOrder === 7) {
    indicators.push('زيادة معدلات الالتحاق', 'تحسين جودة التعليم');
  }
  if (axisOrder === 9) {
    indicators.push('استدامة الصندوق الدوار', 'تمكين اقتصادي للمستفيدين');
  }

  return indicators;
}

/**
 * تحديد التحديات المحتملة لكل معيار
 */
function getPotentialChallenges(axisOrder, title) {
  const challenges = ['نقص الموارد', 'مقاومة التغيير', 'صعوبة التنسيق'];
  
  if (axisOrder === 2) {
    challenges.push('اختلاف أولويات الشركاء', 'بيروقراطية');
  }
  if (axisOrder === 4) {
    challenges.push('تكلفة البنية التحتية', 'صعوبة تغيير السلوك');
  }
  if (axisOrder === 5) {
    challenges.push('نقص الكوادر الصحية', 'صعوبة الوصول للمناطق النائية');
  }
  if (axisOrder === 8) {
    challenges.push('نقص الخبرات التدريبية', 'صعوبة التوظيف');
  }
  if (axisOrder === 9) {
    challenges.push('مخاطر القروض', 'صعوبة السداد');
  }

  return challenges;
}

export default buildEnhancedStandards;
